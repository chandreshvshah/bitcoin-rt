<!DOCTYPE html>

<meta charset="utf-8" />

<link rel="stylesheet" type="text/css" href="default_styling.css">
<script src="prototype.1.7.1.js"></script>
<script src="jsmysql.js"></script>
<script language="javascript" type="text/javascript">

  var wsUri = "wss://blockchain.info/inv";
  var output;
  var myDiv;

  function init()
  {
    output = document.getElementById("output");
	myDiv = document.getElementById("myDiv");
    initWebSocket();
  }

  function initWebSocket()
  {
    websocket = new WebSocket(wsUri);
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
  }

  function onOpen(evt)
  {
    writeToScreen("CONNECTED");
    doSend('{"op":"unconfirmed_sub"}');
	//doSend('{"op":"blocks_sub"}');
  }

  function onClose(evt)
  {
    writeToScreen("DISCONNECTED");
	initWebSocket(); // re-initiate WebSocket
  }

function onMessage(evt)
{
    writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data + '</span>');
	// Parse JSON string into JSON object
	var jsonObj = JSON.parse(evt.data);
	// Grab IP address and translate to integer representation
	var ipAdd = jsonObj.x.relayed_by;
	var intIpAdd = ipAddToIntegerRep(ipAdd);
	// Match geo IP in mySQL and return lat-long coordinates
	var jsonLocation = makeQueryCDDB("SELECT l.* FROM blocks b JOIN locations l ON (b.locId = l.locId) WHERE " + intIpAdd + " BETWEEN b.startIp AND b.endIp LIMIT 1;");
	// Check for errors
	if (!jsonLocation.hasOwnProperty("locId"))
		return;
	myDiv.innerHTML = jsonLocation.latitude;
}

  function onError(evt)
  {
    writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
  }

  function doSend(message)
  {
    writeToScreen("SENT: " + message); 
    websocket.send(message);
  }	

  function writeToScreen(message)
  {
    var pre = document.createElement("p");
    pre.style.wordWrap = "break-word";
    pre.innerHTML = message;
    output.appendChild(pre);
  }

  function parseResponse(responseRaw) {
  
	//var jsonObj = JSON.parse(responseRaw);
  }

function ipAddToIntegerRep(ipAdd)
{
	var ipAddArray = ipAdd.split(".");
	var ipAddArrayInt = ipAddArray.map(function (x) {
		return parseInt(x, 10);
	});
	var intIpAdd = (16777216*ipAddArrayInt[0])+(65536*ipAddArrayInt[1])+(256*ipAddArrayInt[2])+ipAddArrayInt[3];
	
	return intIpAdd;
}
  
function makeQueryCDDB(query) 
{
	jsmysqlSetOption("output_type","json");
	return jsmysqlQuery(query);
}

window.addEventListener("load", init, false);
  
  
</script>
<div id="myDiv"></div>
<div id="output"></div>

</html> 