function jspgQuery(e,t){new Ajax.Request(ajax_path,{method:"get",asynchronous:jspgOption["asynchronous"],parameters:{pgsql:e},onSuccess:function(e){if(jspgOption["output_type"]=="json"&&e.responseText.length>0){ajax_out=e.responseText.substr(0,e.responseText.length/2);ajax_out=ajax_out.evalJSON();manageNewTX(ajax_out,t)}else if(jspgOption["output_type"]=="text"){ajax_out=e.responseText}}})}function jspgSetOption(e,t){jspgOption[e]=t}function jspgGetOption(e){if(jspgOption[e])return jspgOption[e];else return false}function initCanvas(){mapScreenWidth=window.innerWidth;mapScreenHeight=window.innerHeight;stage=new Kinetic.Stage({container:"container",width:mapScreenWidth,height:mapScreenWidth});layer0=new Kinetic.Layer;layer1=new Kinetic.Layer;layer2=new Kinetic.Layer;layer3=new Kinetic.Layer;layer4=new Kinetic.Layer;var e=new Image;e.onload=function(){var t=new Kinetic.Image({x:0,y:0,image:e,width:mapScreenWidth,height:mapScreenHeight});layer0.add(t);stage.add(layer0);initWebSocket()};e.src="images/worldmap_bg.png"}function initLogo(){var e="Bitcoin-RT";var t="Watch bitcoin transactions relayed across the globe in realtime";var n=new Kinetic.Text({text:e,x:0,y:mapScreenHeight/2-72,fill:"white",fontSize:72,fontFamily:"Changa One",opacity:1});layer4.add(n);var r=new Kinetic.Tween({node:n,duration:1,easing:Kinetic.Easings.BackEaseOut,x:mapScreenWidth/2-n.getWidth()/2,onFinish:function(){i.play()}});var i=new Kinetic.Tween({node:n,duration:7,opacity:0});var s=new Kinetic.Text({text:t,x:mapScreenWidth,y:mapScreenHeight/2,fill:"white",fontSize:24,fontFamily:"Changa One",fontStyle:"italic",opacity:1});layer4.add(s);var o=new Kinetic.Tween({node:s,duration:1,easing:Kinetic.Easings.BackEaseOut,x:mapScreenWidth/2-s.getWidth()/2,onFinish:function(){u.play()}});var u=new Kinetic.Tween({node:s,duration:7,opacity:0});stage.add(layer4);r.play();o.play()}function animateNewBlock(){var e=new Kinetic.Rect({x:0,y:0,width:mapScreenWidth,height:mapScreenHeight,fill:"white",stroke:"white",strokeWidth:5,opacity:1});layer4.add(e);var t=new Kinetic.Tween({node:e,duration:.5,x:0,y:mapScreenHeight,width:0,height:0,opacity:0,easing:Kinetic.Easings.Linear,onFinish:function(){e.destroy()}});var n=new Kinetic.Text({x:mapScreenWidth/2,y:mapScreenHeight/2,text:"New block found!",fontSize:24,fontFamily:"Changa One",fill:"white",opacity:1});n.setOffset(n.getWidth()/2,0);layer4.add(n);var r=new Kinetic.Tween({node:n,opacity:0,duration:2,easing:Kinetic.Easings.EaseIn,onFinish:function(){n.destroy()}});stage.add(layer4);t.play();r.play()}function TX(e,t){this.hasError=false;this.ipAddress=t.x.relayed_by;this.hash=t.x.hash;this.longitude=e.longitude;this.latitude=e.latitude;this.country=e.country;this.region=e.region;this.city=e.city;this.postalCode=e.postalcode;this.metroCode=e.metrocode;this.areaCode=e.areacode;this.ipName=e.ipname;this.xpos=mapScreenWidth*(this.longitude-mapGeoLeft)/(mapGeoRight-mapGeoLeft);this.ypos=mapScreenHeight-mapScreenHeight*(this.latitude-mapGeoBottom)/(mapGeoTop-mapGeoBottom);this.continent=e.continent;this.mapNode=function(){var e=new Kinetic.Circle({x:this.xpos,y:this.ypos,radius:.75,fill:"white",strokeWidth:0});layer1.add(e);stage.add(layer1)};this.ripple=function(){var e=new Kinetic.Circle({x:this.xpos,y:this.ypos,radius:.75,stroke:"white",strokeWidth:1,opacity:1});layer2.add(e);stage.add(layer2);var t=new Kinetic.Tween({node:e,duration:.75,radius:10,onFinish:function(){e.destroy()}});t.play()};this.heatNet=function(){var e=3;var t,n;var r=15;var i=2*Math.PI;var s=new Array(e);var o=new Array(e);var u=new Array(e);for(var a=0;a<e;a++){t=r*Math.random();n=i*Math.random();s[a]=t*Math.cos(n);o[a]=t*Math.sin(n);u[a]=new Kinetic.Line({points:[this.xpos,this.ypos,this.xpos+s[a],this.ypos+o[a]],stroke:"white",strokeWidth:1,opacity:.1});layer1.add(u[a])}stage.add(layer1)};this.sideLine=function(){var e=cleanStringLocation(this);var t,n;var r=new Kinetic.Text({text:e,x:this.xpos,y:this.ypos,fill:"white",opacity:1,fontSize:10,fontFamily:"Droid Sans Mono",shadowColor:"black",shadowBlur:2,shadowOffset:[1,1],shadowOpacity:.2});t=this.longitude<130?-12:r.getWidth()+12;n=6;r.setOffset(t,n);layer3.add(r);stage.add(layer3);var i=new Kinetic.Tween({node:r,duration:5,opacity:0,onFinish:function(){r.destroy()}});i.play()}}function initWebSocket(){websocket=new WebSocket(wsURI);websocket.onopen=function(e){onOpen(e)};websocket.onclose=function(e){onClose(e)};websocket.onmessage=function(e){onMessage(e)};websocket.onerror=function(e){onError(e)}}function onOpen(e){zero=Date.now()/1e3|0;webSocketOpen=true;document.getElementById("pageStatus").innerHTML="Connected to Bitcoin network!";websocket.send('{"op":"unconfirmed_sub"}');websocket.send('{"op":"blocks_sub"}');if(firstRun)initLogo();firstRun=false}function onClose(e){initWebSocket()}function onMessage(e){var t=JSON.parse(e.data);if(t.op=="utx")handleOP(t);if(t.op=="block")handleBlock(t)}function onError(e){}function handleOP(e){var t=e.x.relayed_by.split(".");var n=t.map(function(e){return parseInt(e,10)});var r=16777216*n[0]+65536*n[1]+256*n[2]+n[3];jspgSetOption("output_type","json");jspgQuery("SELECT l.* FROM blocks b JOIN locations2 l ON (b.locid::text = l.locid_del) WHERE "+r+" BETWEEN b.startip AND b.endip LIMIT 1;",e)}function handleBlock(e){animateNewBlock();counterBlocks++;document.getElementById("pageBlocks").innerHTML=counterBlocks}function manageNewTX(e,t){var n=new TX(e,t);if(n.hasError)return;n.mapNode();n.ripple();n.heatNet();n.sideLine();updateExternalDisplays(n)}function toggleDivDisplay(e,t){if(window[t]){document.getElementById(e).style.visibility="visible";window[t]=false}else{document.getElementById(e).style.visibility="hidden";window[t]=true}}function updateExternalDisplays(e){counterTX++;document.getElementById("pageNumofTX").innerHTML=counterTX;document.title="Bitcoin-RT ["+counterTX+" tx]";var t="TX Hash: <b>"+e.hash.substring(0,15)+"</b><br />Relay IP: <b>"+e.ipAddress+"</b><br />Location: <b>"+cleanStringLocation(e)+"</b><br />Lat, Long: <b>"+e.latitude+", "+e.longitude+"</b>";document.getElementById("pageStatus").innerHTML=t}function cleanStringLocation(e){var t;t=e.city!==""?e.city+", ":"Unidentified city in ";t=e.country=="USA"&&e.region!==""?t+e.region+", "+e.country:t+e.country;t=e.ipName==""||e.ipName=="null"?t:t+" ("+e.ipName+")";return t}function updateClock(){if(!webSocketOpen)return;time=(Date.now()/1e3|0)-zero;timeHr=time/3600|0;timeMin=time%3600/60|0;timeSec=time%3600%60;timeMin=timeMin<10?"0"+timeMin:timeMin;timeSec=timeSec<10?"0"+timeSec:timeSec;cleanTime=timeHr+":"+timeMin+":"+timeSec;document.getElementById("pageClock").innerHTML=cleanTime}var ajax_path="comm-pg.php";var ajax_out="";var jspgOption={output_type:"json",asynchronous:true,max_records:2e6};var stage,layer0,layer1,layer2,layer3,layer4;var mapGeoLeft=-180;var mapGeoRight=180;var mapGeoTop=90;var mapGeoBottom=-90;var mapScreenWidth;var mapScreenHeight;var wsURI="wss://ws.blockchain.info/inv";var firstRun=true;var counterTX=0;var counterBlocks=0;var zero,time,timeHr,timeMin,timeSec,cleanTime;var qInfoHidden=true;var donateQRHidden=true;var webSocketOpen=false;var continentsData={NA:1,SA:2,EU:3,AF:4,AS:2,OC:1}